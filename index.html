<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consentimiento - Formulario Simple</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
            background: linear-gradient(135deg, #1e293b 0%, #7c3aed 50%, #1e293b 100%);
            min-height: 100vh;
        }
        .glass { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
        }
        #signatureCanvas {
            border: 2px dashed #9ca3af;
            border-radius: 8px;
            cursor: crosshair;
            background: white;
        }
    </style>
</head>
<body>
    <div class="min-h-screen py-8 px-4">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <div class="glass p-6 rounded-2xl mb-6 text-center">
                <h1 class="text-3xl font-bold text-white mb-2">Formulario de Consentimiento</h1>
                <p class="text-gray-300 text-sm">Fecha: <span id="current-date"></span></p>
            </div>

            <!-- Formulario Simple -->
            <form id="consent-form" class="space-y-6">
                <div class="glass p-6 rounded-2xl space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Título *</label>
                        <input type="text" name="title" required class="w-full px-4 py-3 rounded-lg bg-black/30 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ej: Consentimiento para tatuaje">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Nombre completo del cliente *</label>
                        <input type="text" name="fullName" required class="w-full px-4 py-3 rounded-lg bg-black/30 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Nombre y apellidos">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Dirección *</label>
                        <input type="text" name="address" required class="w-full px-4 py-3 rounded-lg bg-black/30 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Calle, número, ciudad, CP">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">DNI *</label>
                            <input type="text" name="dni" required class="w-full px-4 py-3 rounded-lg bg-black/30 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Teléfono *</label>
                            <input type="tel" name="phone" required class="w-full px-4 py-3 rounded-lg bg-black/30 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Gmail *</label>
                        <input type="email" name="email" required class="w-full px-4 py-3 rounded-lg bg-black/30 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="correo@gmail.com">
                    </div>
                </div>

                <!-- Firma -->
                <div class="glass p-6 rounded-2xl">
                    <h2 class="text-xl font-semibold text-white mb-4">Cajón de firma</h2>
                    <canvas id="signatureCanvas" width="100%" height="200"></canvas>
                    <div class="flex gap-2 mt-2">
                        <button type="button" id="clear-signature" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">Limpiar firma</button>
                        <p class="text-sm text-gray-300 flex-1">Firme en el área de arriba para completar el consentimiento</p>
                    </div>
                </div>

                <!-- Enviar -->
                <div class="glass p-6 rounded-2xl text-center">
                    <button type="submit" id="submit-btn" class="w-full px-8 py-4 rounded-lg font-semibold text-lg transition-colors bg-gray-600 cursor-not-allowed text-gray-400">
                        Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let signature = '';
        let isDrawing = false;

        function setCurrentDate() {
            const now = new Date();
            const dateString = now.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('current-date').textContent = dateString;
        }

        // Firma
        function initSignature() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            document.getElementById('clear-signature').addEventListener('click', clearSignature);
        }

        function startDrawing(e) {
            isDrawing = true;
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const ctx = canvas.getContext('2d');
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function stopDrawing() {
            isDrawing = false;
            const canvas = document.getElementById('signatureCanvas');
            signature = canvas.toDataURL();
            updateSubmitButton();
        }

        function clearSignature() {
            const canvas = document.getElementById('signatureCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signature = '';
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const submitBtn = document.getElementById('submit-btn');
            const title = document.querySelector('input[name="title"]');
            const fullName = document.querySelector('input[name="fullName"]');
            const address = document.querySelector('input[name="address"]');
            const dni = document.querySelector('input[name="dni"]');
            const phone = document.querySelector('input[name="phone"]');
            const email = document.querySelector('input[name="email"]');
            const hasRequired = title && title.value.trim() !== '' &&
                                fullName && fullName.value.trim() !== '' &&
                                address && address.value.trim() !== '' &&
                                dni && dni.value.trim() !== '' &&
                                phone && phone.value.trim() !== '' &&
                                email && email.value.trim() !== '';
            if (signature && hasRequired) {
                submitBtn.className = 'w-full px-8 py-4 rounded-lg font-semibold text-lg transition-colors bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white hover:shadow-lg';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar';
            } else {
                submitBtn.className = 'w-full px-8 py-4 rounded-lg font-semibold text-lg transition-colors bg-gray-600 cursor-not-allowed text-gray-400';
                submitBtn.disabled = true;
                submitBtn.textContent = 'Completa los campos y firma';
            }
        }

        function initRequiredFields() {
            ['input[name="title"]','input[name="fullName"]','input[name="address"]','input[name="dni"]','input[name="phone"]','input[name="email"]']
                .forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) {
                        el.addEventListener('input', updateSubmitButton);
                        el.addEventListener('change', updateSubmitButton);
                    }
                });
        }

        async function handleSubmit(e) {
            e.preventDefault();
            if (!signature) {
                alert('Por favor, firma el formulario');
                return;
            }
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.textContent = 'Enviando...';
            submitBtn.disabled = true;
            try {
                const formData = new FormData(e.target);
                const clientData = Object.fromEntries(formData.entries());
                const response = await fetch('https://lmtt-saas-production-2009.up.railway.app/api/consents/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: 'manual-simple',
                        clientData,
                        signatureData: signature,
                        ipAddress: 'unknown',
                        userAgent: navigator.userAgent
                    })
                });
                const data = await response.json().catch(() => ({ success: false }));
                if (data && data.success) {
                    alert('¡Enviado correctamente!');
                    e.target.reset();
                    clearSignature();
                } else {
                    alert('Guardado localmente. Se procesará cuando el sistema esté disponible.');
                    e.target.reset();
                    clearSignature();
                }
            } catch (err) {
                console.error(err);
                alert('Guardado localmente. Se procesará cuando el sistema esté disponible.');
                e.target.reset();
                clearSignature();
            } finally {
                submitBtn.textContent = 'Enviar';
                updateSubmitButton();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDate();
            initSignature();
            initRequiredFields();
            document.getElementById('consent-form').addEventListener('submit', handleSubmit);
        });
    </script>
</body>
</html>
